## 4.1  worker pool（goroutine池）

- 本质上是生产者消费者模型
- 可以有效控制goroutine数量，防止暴涨
- 需求：
  - 计算一个数字的各个位数之和，例如数字123，结果为1+2+3=6
  - 随机生成数字进行计算
- 控制台输出结果如下：

```txt
job id:216725 randnum:395744901331073481 result:72
job id:216726 randnum:6652960329739139415 result:90
job id:216727 randnum:607706999294507439 result:96
job id:216728 randnum:5095908432305777291 result:86
job id:216729 randnum:4006323562397937047 result:80
job id:216730 randnum:8241267014879546314 result:82
job id:216731 randnum:7290239214797493668 result:98
job id:216732 randnum:3778856873577198163 result:109
job id:216733 randnum:1145383762817909330 result:80
job id:216734 randnum:4271235551408999 result:74
job id:216735 randnum:7201918142977307461 result:79
job id:216736 randnum:7332986139197581644 result:96
job id:216737 randnum:1834394941390380372 result:81
job id:216739 randnum:4594951236992042151 result:81
job id:216738 randnum:5363616994831865949 result:105
job id:216740 randnum:3478339391855366640 result:93

```

```go
package main

import (
    "fmt"
    "math/rand"
)

type Job struct {
    // id
    Id int
    // 需要计算的随机数
    RandNum int
}

type Result struct {
    // 这里必须传对象实例
    job *Job
    // 求和
    sum int
}

func main() {
    // 需要2个管道
    // 1.job管道
    jobChan := make(chan *Job, 128)
    // 2.结果管道
    resultChan := make(chan *Result, 128)
    // 3.创建工作池
    createPool(64, jobChan, resultChan)
    // 4.开个打印的协程
    go func(resultChan chan *Result) {
        // 遍历结果管道打印
        for result := range resultChan {
            fmt.Printf("job id:%v randnum:%v result:%d\n", result.job.Id,
                result.job.RandNum, result.sum)
        }
    }(resultChan)
    var id int
    // 循环创建job，输入到管道
    for {
        id++
        // 生成随机数
        r_num := rand.Int()
        job := &Job{
            Id:      id,
            RandNum: r_num,
        }
        jobChan <- job
    }
}

// 创建工作池
// 参数1：开几个协程
func createPool(num int, jobChan chan *Job, resultChan chan *Result) {
    // 根据开协程个数，去跑运行
    for i := 0; i < num; i++ {
        go func(jobChan chan *Job, resultChan chan *Result) {
            // 执行运算
            // 遍历job管道所有数据，进行相加
            for job := range jobChan {
                // 随机数接过来
                r_num := job.RandNum
                // 随机数每一位相加
                // 定义返回值
                var sum int
                for r_num != 0 {
                    tmp := r_num % 10
                    sum += tmp
                    r_num /= 10
                }
                // 想要的结果是Result
                r := &Result{
                    job: job,
                    sum: sum,
                }
                //运算结果扔到管道
                resultChan <- r
            }
        }(jobChan, resultChan)
    }
}
```