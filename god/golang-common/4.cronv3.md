## 1.下载依赖库
```shell
go get -u github.com/robfig/cron/v3
```
## 2. 配置任务
```go
package manager

import (
	"errors"
	"fmt"
	"reflect"
	"runtime"
	"strings"
	"time"

	"github.com/robfig/cron/v3"
	"github.com/sirupsen/logrus"
	log "github.com/sirupsen/logrus"

	"mikan/internal/common"
	C "mikan/internal/constants"
	"mikan/internal/jobs"
	"mikan/internal/model"
	"mikan/internal/resource"
	"mikan/internal/service/es"
)

type JobDetail struct {
	model.GolangJob
	Active     bool     `json:"active"`
	Status     string   `json:"status"`
	CronDetail []string `json:"cronDetail"`
	Log        string   `json:"log"`
}

var cronObj *cron.Cron
var jobMap = make(map[uint]cron.EntryID)
var parser = cron.NewParser(cron.Second | cron.Minute | cron.Hour | cron.Dom | cron.Month | cron.Dow | cron.Descriptor)

func InitJob() error {
	log.Info("初始化定时任务")
	cronObj = cron.New(cron.WithSeconds(),
		cron.WithChain(recoverAndIfStillRunning()),
	)
	jobDao := model.GolangJobDao{}
	jobList, err := jobDao.SelectAllEnableJob(resource.IronDB)
	if err != nil {
		log.Warnf("获取任务失败: %v", err)
		return err
	}
	for _, jobItem := range jobList {
		jobVal := jobs.JobMap[jobItem.JobName]
		baseJob, initErr := jobVal.Init(jobItem.JobMetaData, jobItem)
		if initErr != nil {
			log.Warnf("初始化任务失败: %v", initErr)
			return initErr
		}
		entryID, addJobErr := cronObj.AddJob(jobItem.CronString, baseJob)
		if addJobErr != nil {
			log.Warnf("添加任务失败: %v", addJobErr)
			return addJobErr
		}
		jobMap[jobItem.ID] = entryID
	}
	cronObj.Start()
	return nil
}

func recoverAndIfStillRunning() cron.JobWrapper {
	return func(j cron.Job) cron.Job {
		var ch = make(chan struct{}, 1)
		ch <- struct{}{}
		return cron.FuncJob(func() {
			defer func() {
				if r := recover(); r != nil {
					const size = 64 << 10
					buf := make([]byte, size)
					buf = buf[:runtime.Stack(buf, false)]
					err, ok := r.(error)
					if !ok {
						err = fmt.Errorf("%v", r)
					}
					logrus.Error(err, "panic", "stack", "...\n"+string(buf))
					ch <- struct{}{}
				}
			}()
			select {
			case v := <-ch:
				j.Run()
				ch <- v
			default:
				logrus.Info("skip")
			}
		})
	}
}

// 获取下次执行时间
func getNextRunTime(cronString string, times int) ([]string, error) {
	scheduler, err := parser.Parse(cronString)
	if err != nil {
		return nil, err
	}
	var cronDetail []string
	timeSchedule := time.Now()
	for i := 0; i < times; i++ {
		timeSchedule = scheduler.Next(timeSchedule)
		cronDetail = append(cronDetail, timeSchedule.Format("2006-01-02 15:04:05"))
	}
	return cronDetail, nil
}

// 获取任务执行详情
func QueryById(id uint) (JobDetail, error) {
	jobDao := model.GolangJobDao{}
	job, err := jobDao.SelectById(resource.IronDB, id)
	if err != nil {
		log.Warnf("获取任务失败: %v", err)
		return JobDetail{}, err
	}
	cronDetail, err := getNextRunTime(job.CronString, 5)
	if err != nil {
		log.Warnf("解析任务执行时间失败: %v", err)
		return JobDetail{}, err
	}
	active := cronObj.Entry(jobMap[job.ID]).Valid()
	status := ""
	if active {
		status = "运行中"
	} else {
		status = "已停止"
	}
	logBuffer := strings.Builder{}
	esService := es.NewService()
	jobKey := jobs.GenerateJobKey(job)
	logRes, err := esService.QueryLog(jobKey, time.Now().Add(-time.Hour*24), time.Now(), 0, 200)
	if err != nil {
		log.Warnf("获取任务日志失败: %v", err)
	} else {
		hitArray := logRes.Each(reflect.TypeOf(map[string]any{}))

		for _, logItem := range hitArray {
			mapSource := logItem.(map[string]any)
			timeStr := mapSource["timestamp"].(string)
			t, _ := time.Parse(time.RFC3339, timeStr)
			t = t.Add(time.Hour * 8)
			level := mapSource["level"].(string)
			msg := mapSource["message"].(string)
			line := fmt.Sprintf("time=\"%s\" level=\"%s\" msg=\"%s\"\n", t.Format("2006-01-02 15:04:05"), level, msg)
			logBuffer.WriteString(line)
		}
	}

	jobDetail := JobDetail{
		GolangJob:  job,
		Active:     cronObj.Entry(jobMap[job.ID]).Valid(),
		Status:     status,
		CronDetail: cronDetail,
		Log:        logBuffer.String(),
	}
	return jobDetail, nil
}

// 获取任务列表
func QueryWithPage(page, limit int) (common.PageData, error) {
	jobDao := model.GolangJobDao{}
	jobList, total, err := jobDao.SelectJobWithPage(resource.IronDB, page, limit)
	if err != nil {
		log.Warnf("获取任务失败: %v", err)
		return common.PageData{}, err
	}
	var jobDetailList []JobDetail
	for _, jobItem := range jobList {

		active := cronObj.Entry(jobMap[jobItem.ID]).Valid()
		status := ""
		if active {
			status = "运行中"
		} else {
			status = "已停止"
		}
		jobDetail := JobDetail{
			GolangJob:  jobItem,
			Active:     cronObj.Entry(jobMap[jobItem.ID]).Valid(),
			Status:     status,
			CronDetail: []string{},
		}
		jobDetailList = append(jobDetailList, jobDetail)
	}
	return common.PageData{
		Total:       total,
		Data:        jobDetailList,
		PageSize:    limit,
		CurrentPage: page,
	}, nil
}

// 启动任务
func StartJob(id uint) error {
	if cronObj.Entry(jobMap[id]).Valid() {
		log.Warnf("任务已经在运行中: %v", id)
		return nil
	}
	jobDao := model.GolangJobDao{}
	job, err := jobDao.SelectById(resource.IronDB, id)
	if err != nil {
		log.Warnf("获取任务失败: %v", err)
		return err
	}
	if job.Enable == C.JobDisable {

```