Connections
-----

尽管用户仅提供`URL`，但`OkHttp`使用以下三种类型计划其与Web服务器的连接：`URL`，地址和路由。

## URLs

URL(例如https://github.com/square/okhttp)是HTTP和Internet的基础。 他们不仅是针对网络上所有内容的通用分散式命名方案,同时还规定了如何访问网络资源。

网址是抽象的

* 他们指定请求可以是纯文本`http`或加密(`https`)，但不能指定使用哪种加密算法。 他们也没有指定如何验证对等方的证书(`HostnameVerifier`)或可以信任的证书(`SSLSocketFactory`)。
* 他们没有指定是否应使用特定的代理服务器或如何使用该代理服务器进行身份验证。

它们也很具体:每个网址都标识一个特定的路径(如`/square/okhttp`)和查询(如`?q=sharks&lang=en`)。 每个Web服务器托管许多`URL`。

## 地址

地址指定一个Web服务器(例如`github.com`)和连接到该服务器所需的所有静态配置：端口号，HTTPS设置，和首选网络协议（例如`HTTP/2`或`SPDY`).

共享相同地址的URL也可能共享相同的基础TCP套接字(socket)连接。 共享连接具有显着的性能优势：更低的延迟，更高的吞吐量(由于TCP启动缓慢)和电量消耗。 `OkHttp`使用一个`ConnectionPool`，它可以自动重用`HTTP/1.x`连接并多路复用`HTTP/2`和`SPDY`连接。

> 译者注:  `OkHttp`在安卓领域有较多应用，所以官方会提到性能和电量消耗

在OkHttp中，地址的某些字段来自`URL`(方案、主机名、端口)，其余部分来自`OkHttpClient`。

## 路由

路由的定义:

路由提供实际连接到Web服务器所需的动态信息。 这是要尝试的特定IP地址(由DNS查询发现)，要使用的确切代理服务器(如果正在使用`ProxySelector`)以及要协商的`TLS`版本(对于`HTTPS`连接)。

一个地址可能有很多路由。 例如: 托管在多个数据中心中的Web服务器可能会在其DNS响应中产生多个IP地址。

## 连接数

当您使用OkHttp请求URL时，它的作用是：

1. 使用URL并配置了`OkHttpClient`来创建地址。 该地址指定了我们如何连接到网络服务器。
2. 从连接池中检索是否已有该地址的连接，如果有则尝试复用
3. 如果在池中找不到连接，则选择要尝试的路由。 这通常意味着发出`DNS`请求以获取服务器的IP地址。 然后根据需要选择TLS版本和代理服务器。
4. 如果是新路由，则可以通过建立直接套接字连接，`TLS`隧道（用于通过`HTTP`代理的`HTTPS`）或直接TLS连接来进行连接。 它根据需要执行TLS握手。
5. 发送HTTP请求并读取响应。

如果连接出现问题，`OkHttp`将选择其他路由，然后重试。 这样，当服务器地址的一部分无法访问时，`OkHttp`可以恢复。 如果共用连接失效或尝试的`TLS`版本不受支持，重试机制不会受影响。

收到响应后，连接将返回到池中，以便可以将其重新用于以后的请求。 闲置一段时间后，连接将从池中退出。